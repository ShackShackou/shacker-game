<!DOCTYPE html>
<html>
<head>
    <title>WalletConnect for OpenSea</title>
    <script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body>
<script>
// WalletConnect Integration for OpenSea iframes
window.WalletConnectIntegration = {
    provider: null,
    
    async connect() {
        try {
            // Create WalletConnect Provider
            const provider = new WalletConnectProvider.default({
                infuraId: "9aa3d95b3bc440fa88ea12eaa4456161", // Public Infura ID
                rpc: {
                    1: "https://eth-mainnet.public.blastapi.io",
                    137: "https://polygon-rpc.com",
                    56: "https://bsc-dataseed.binance.org"
                },
                qrcodeModal: {
                    open: (uri, cb) => {
                        // Custom modal for OpenSea compatibility
                        this.showQRModal(uri, cb);
                    },
                    close: () => {
                        this.closeQRModal();
                    }
                }
            });

            // Enable session (triggers QR Code modal)
            await provider.enable();
            
            this.provider = provider;
            
            // Get accounts
            const accounts = await provider.request({ 
                method: 'eth_accounts' 
            });
            
            return {
                success: true,
                address: accounts[0],
                provider: provider
            };
            
        } catch (error) {
            console.error("WalletConnect error:", error);
            return {
                success: false,
                error: error.message
            };
        }
    },
    
    showQRModal(uri, cb) {
        // Create modal overlay
        const modal = document.createElement('div');
        modal.id = 'walletconnect-modal';
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        `;
        
        // Modal content
        const content = document.createElement('div');
        content.style.cssText = `
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 400px;
            text-align: center;
        `;
        
        content.innerHTML = `
            <h2 style="color: #333; margin-bottom: 20px;">Connect Wallet</h2>
            <div id="qrcode-container" style="margin: 20px auto;"></div>
            <p style="color: #666; margin: 20px 0;">Scan with your wallet app</p>
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                <button onclick="window.open('${uri}', '_blank')" style="
                    background: #4099ff;
                    color: white;
                    border: none;
                    padding: 12px 24px;
                    border-radius: 10px;
                    cursor: pointer;
                    font-size: 16px;
                ">Open in Wallet</button>
                <button onclick="WalletConnectIntegration.closeQRModal()" style="
                    background: #ff4444;
                    color: white;
                    border: none;
                    padding: 12px 24px;
                    border-radius: 10px;
                    cursor: pointer;
                    font-size: 16px;
                ">Cancel</button>
            </div>
            <div style="margin-top: 20px;">
                <p style="color: #999; font-size: 14px;">Popular wallets:</p>
                <div style="display: flex; justify-content: center; gap: 15px; margin-top: 10px;">
                    <a href="https://metamask.app.link/dapp/${window.location.host}" target="_blank">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/3/36/MetaMask_Fox.svg" width="40" height="40" alt="MetaMask">
                    </a>
                    <a href="https://link.trustwallet.com/open_url?url=${encodeURIComponent(window.location.href)}" target="_blank">
                        <img src="https://trustwallet.com/assets/images/media/assets/trust_platform.svg" width="40" height="40" alt="Trust">
                    </a>
                    <a href="${uri}" target="_blank">
                        <img src="https://rainbow.me/img/rainbow.svg" width="40" height="40" alt="Rainbow">
                    </a>
                </div>
            </div>
        `;
        
        modal.appendChild(content);
        document.body.appendChild(modal);
        
        // Generate QR code
        this.generateQR(uri, 'qrcode-container');
        
        if (cb) cb();
    },
    
    closeQRModal() {
        const modal = document.getElementById('walletconnect-modal');
        if (modal) {
            modal.remove();
        }
    },
    
    generateQR(text, containerId) {
        // Simple QR code generator using Google Charts API
        const container = document.getElementById(containerId);
        if (container) {
            const qrImage = document.createElement('img');
            qrImage.src = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(text)}`;
            qrImage.style.cssText = 'max-width: 100%; height: auto;';
            container.appendChild(qrImage);
        }
    },
    
    async signMessage(message) {
        if (!this.provider) {
            throw new Error('No wallet connected');
        }
        
        const accounts = await this.provider.request({ 
            method: 'eth_accounts' 
        });
        
        const signature = await this.provider.request({
            method: 'personal_sign',
            params: [message, accounts[0]]
        });
        
        return signature;
    },
    
    disconnect() {
        if (this.provider) {
            this.provider.disconnect();
            this.provider = null;
        }
    }
};

// Expose globally
window.WalletConnectIntegration = WalletConnectIntegration;
</script>
</body>
</html>